<!DOCTYPE html>
<html lang="en">
  <head>
    <script src="../customElements/head-element.js"></script>
    <custom-head
      page-title="Checkout - POStore"
      description="Checkout page for POStore, where you can review your cart items, select a shipping method, and complete your purchase securely with PayPal."
      keywords="checkout, cart, payment, PayPal, shipping, order summary"
      author="POStore Team"
      favicon-url="../assets/favicon.ico"
      stylesheets="../css/style.css"
    ></custom-head>

    <script src="../js/globalState.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="../js/supabase-config.js"></script>
    <script src="../js/business-data.js"></script>
    <script src="../js/store-functions.js"></script>
    <script src="../js/main.js"></script>

    <!-- PayPal SDK add paypal script dinamically -->
    <script>
      // Wait for business data to load
      function loadPayPalScript() {
        if (!window.globalStore) {
          setTimeout(loadPayPalScript, 100);
          return;
        }

        const globalState = window.globalStore.getState();
        const paypalClientId =
          globalState.PaypalClientId ||
          globalState.paypalclientid ||
          globalState.PayPalClientId ||
          globalState.paypal_client_id;

        if (!paypalClientId) {
          console.log(
            "Waiting for PayPal Client ID...",
            "Available keys:",
            Object.keys(globalState)
          );
          setTimeout(loadPayPalScript, 200);
          return;
        }

        console.log("Loading PayPal SDK with Client ID:", paypalClientId);
        const scriptElement = document.createElement("script");
        scriptElement.setAttribute(
          "src",
          `https://www.paypal.com/sdk/js?client-id=${paypalClientId}&currency=USD`
        );
        scriptElement.setAttribute("defer", "");
        scriptElement.setAttribute("id", "paypal-sdk");
        document.head.appendChild(scriptElement);
      }

      // Start loading after DOM is ready
      document.addEventListener("DOMContentLoaded", () => {
        setTimeout(loadPayPalScript, 500); // Give time for business data to load
      });
    </script>
  </head>
  <body class="bg-light">
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
      <div class="container">
        <a
          class="navbar-brand fw-bold text-primary"
          href="../index.html"
          style="font-size: 1.5rem"
        >
          <i class="bi bi-shop me-2"></i><span id="business-name">POStore</span>
        </a>

        <div class="d-flex align-items-center">
          <a href="../index.html" class="btn btn-outline-primary me-2">
            <i class="bi bi-arrow-left me-2"></i>Continue Shopping
          </a>
        </div>
      </div>
    </nav>

    <!-- Checkout Progress -->
    <div class="container mt-4">
      <div class="row justify-content-center">
        <div class="col-lg-8">
          <div class="checkout-progress mb-4">
            <div class="d-flex justify-content-between align-items-center">
              <div class="step active">
                <div class="step-number">1</div>
                <div class="step-label">Cart</div>
              </div>
              <div class="step-line"></div>
              <div class="step active">
                <div class="step-number">2</div>
                <div class="step-label">Checkout & Payment</div>
              </div>
              <div class="step-line"></div>
              <div class="step">
                <div class="step-number">3</div>
                <div class="step-label">Complete</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Checkout Content -->
    <div class="container mb-5">
      <div class="row">
        <!-- Checkout Form -->
        <div class="col-lg-8">
          <!-- Cart Items -->
          <div class="card shadow-sm mb-4">
            <div class="card-header bg-white">
              <h5 class="mb-0"><i class="bi bi-cart me-2"></i>Your Items</h5>
            </div>
            <div class="card-body">
              <div id="cartItems" class="mb-3">
                <!-- Cart items will be populated by JavaScript -->
              </div>
            </div>
          </div>

          <!-- PayPal Info Notice -->
          <div class="card shadow-sm mb-4">
            <div class="card-header bg-white">
              <h5 class="mb-0">
                <i class="bi bi-info-circle me-2"></i>Payment Information
              </h5>
            </div>
            <div class="card-body">
              <div class="alert alert-info mb-0">
                <i class="bi bi-paypal me-2"></i>
                Your shipping and billing information will be collected securely
                through PayPal during checkout. You can pay with PayPal or
                credit/debit card.
              </div>
            </div>
          </div>

          <!-- Shipping Method -->
          <div class="card shadow-sm mb-4">
            <div class="card-header bg-white">
              <h5 class="mb-0">
                <i class="bi bi-box-seam me-2"></i>Shipping Method
              </h5>
            </div>
            <div class="card-body">
              <div class="form-check mb-2">
                <input
                  class="form-check-input"
                  type="radio"
                  name="shipping"
                  id="pickupShipping"
                  value="0"
                  checked
                />
                <label
                  class="form-check-label d-flex justify-content-between w-100"
                  for="pickupShipping"
                >
                  <span>Pickup at Store (Available Today)</span>
                  <span class="fw-bold text-success">FREE</span>
                </label>
              </div>
              <div class="form-check mb-2">
                <input
                  class="form-check-input"
                  type="radio"
                  name="shipping"
                  id="standardShipping"
                  value="5.99"
                />
                <label
                  class="form-check-label d-flex justify-content-between w-100"
                  for="standardShipping"
                >
                  <span>Standard Shipping (5-7 business days)</span>
                  <span class="fw-bold">$5.99</span>
                </label>
              </div>
              <div class="form-check mb-2">
                <input
                  class="form-check-input"
                  type="radio"
                  name="shipping"
                  id="expressShipping"
                  value="12.99"
                />
                <label
                  class="form-check-label d-flex justify-content-between w-100"
                  for="expressShipping"
                >
                  <span>Express Shipping (2-3 business days)</span>
                  <span class="fw-bold">$12.99</span>
                </label>
              </div>
              <div class="form-check">
                <input
                  class="form-check-input"
                  type="radio"
                  name="shipping"
                  id="overnightShipping"
                  value="24.99"
                />
                <label
                  class="form-check-label d-flex justify-content-between w-100"
                  for="overnightShipping"
                >
                  <span>Overnight Shipping (1 business day)</span>
                  <span class="fw-bold">$24.99</span>
                </label>
              </div>
            </div>
          </div>
        </div>

        <!-- Order Summary -->
        <div class="col-lg-4">
          <div class="card shadow-sm sticky-top" style="top: 20px">
            <div class="card-header bg-white">
              <h5 class="mb-0">
                <i class="bi bi-receipt me-2"></i>Order Summary
              </h5>
            </div>
            <div class="card-body">
              <div id="orderItems">
                <!-- Order items will be populated by JavaScript -->
              </div>

              <hr />

              <div class="d-flex justify-content-between mb-2">
                <span>Subtotal:</span>
                <span id="subtotal">$0.00</span>
              </div>
              <div class="d-flex justify-content-between mb-2">
                <span>Shipping:</span>
                <span id="shippingCost">$0.00</span>
              </div>
              <div class="d-flex justify-content-between mb-2">
                <span>Tax:</span>
                <span id="tax">$0.00</span>
              </div>
              <hr />
              <div class="d-flex justify-content-between fw-bold fs-5">
                <span>Total:</span>
                <span id="total">$0.00</span>
              </div>

              <div class="mt-4">
                <!-- PayPal Button Container -->
                <div id="paypal-button-container"></div>

                <!-- PayPal Button Configuration -->
                <script>
                  // Wait for PayPal SDK to load
                  function initPayPal() {
                    if (typeof paypal === "undefined") {
                      setTimeout(initPayPal, 100);
                      return;
                    }

                    // Calculate total from cart
                    const total = document
                      .getElementById("total")
                      .innerText.replace("$", "");

                    paypal
                      .Buttons({
                        // Sets up the transaction when a payment button is clicked
                        createOrder: function (data, actions) {
                          return actions.order.create({
                            purchase_units: [
                              {
                                amount: {
                                  value: total, // Use the total from the order summary
                                  currency_code: "USD",
                                },
                              },
                            ],
                          });
                        },

                        // Finalize the transaction after payer approval
                        onApprove: function (data, actions) {
                          return actions.order
                            .capture()
                            .then(function (orderData) {
                              // Show success modal
                              const orderNumber =
                                orderData.id ||
                                "PP-" + Date.now().toString().slice(-8);

                              document.getElementById(
                                "orderNumber"
                              ).textContent = orderNumber;

                              // Get cart items before clearing
                              const cart = JSON.parse(
                                localStorage.getItem("postore_cart") || "[]"
                              );

                              // Get order items from the DOM
                              const orderItemsHtml =
                                document.getElementById("orderItems").innerHTML;

                              // Modal will be shown only after successful database save

                              // Send confirmation email using EmailJS
                              var script = document.createElement("script");
                              script.src =
                                "https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js";
                              script.onload = async function () {
                                emailjs.init("L7o6hZUmFJQ_Jbqu0");

                                // Get shipping method and calculate delivery date
                                const shippingMethodElement =
                                  document.querySelector(
                                    'input[name="shipping"]:checked'
                                  );
                                const shippingMethod =
                                  shippingMethodElement.nextElementSibling.textContent.trim();
                                const shippingValue = parseFloat(
                                  shippingMethodElement.value
                                );

                                // Calculate estimated delivery date based on shipping method
                                const today = new Date();
                                let deliveryDays = 0;

                                if (shippingValue === 0) {
                                  deliveryDays = 0; // Pickup at Store (Available Today)
                                } else if (shippingValue === 5.99) {
                                  deliveryDays = 7; // Standard Shipping (5-7 business days) - use max
                                } else if (shippingValue === 12.99) {
                                  deliveryDays = 3; // Express Shipping (2-3 business days) - use max
                                } else if (shippingValue === 24.99) {
                                  deliveryDays = 1; // Overnight Shipping (1 business day)
                                }

                                const estimatedDeliveryDate = new Date(today);
                                estimatedDeliveryDate.setDate(
                                  today.getDate() + deliveryDays
                                );

                                // Use cart items captured before clearing
                                let itemsList = "";
                                if (cart && cart.length > 0) {
                                  cart.forEach((item) => {
                                    itemsList += `${
                                      item.Name || "Product"
                                    } - $${item.Price || "0.00"} x ${
                                      item.quantity || 1
                                    }\n`;
                                  });
                                } else {
                                  // Fallback to get items from the order summary HTML
                                  itemsList = "Items as shown in order summary";
                                }

                                // Get payment details from PayPal response
                                const shippingAddress =
                                  orderData.purchase_units[0].shipping
                                    ?.address || {};
                                const addressStr =
                                  shippingAddress.address_line_1
                                    ? `${shippingAddress.address_line_1}, ${
                                        shippingAddress.admin_area_2 || ""
                                      }, ${
                                        shippingAddress.admin_area_1 || ""
                                      }, ${
                                        shippingAddress.postal_code || ""
                                      }, ${shippingAddress.country_code || ""}`
                                    : "Store Pickup";
                                const billingAddress =
                                  orderData.purchase_units[0].shipping
                                    ?.address || {};

                                // Get customer info
                                const customerName =
                                  orderData.payer?.name?.given_name +
                                    " " +
                                    orderData.payer?.name?.surname ||
                                  "Customer";
                                const customerEmail =
                                  orderData.payer?.email_address ||
                                  "customer@example.com";

                                // Save to Supabase first
                                try {
                                  const { data: orderData, error: orderError } =
                                    await supabase
                                      .from("Orders")
                                      .insert({
                                        TotalAmount: parseFloat(total),
                                        StatusId: 1,
                                        PaymentOrderId: orderNumber,
                                        Currency: "USD",
                                        ShippingAddress: addressStr,
                                        ShippingMethod: shippingMethod,
                                        TrackingNumber: null,
                                        EstimatedDeliveryDate:
                                          estimatedDeliveryDate,
                                        CreatedAt: new Date(),
                                        UpdatedAt: new Date(),
                                        BuyerEmail: customerEmail,
                                        BusinessEmail:
                                          window.globalStore?.state?.Email,
                                      })
                                      .select();

                                  if (orderError) {
                                    console.error(
                                      "Error inserting order:",
                                      orderError
                                    );
                                    alert(
                                      "Error saving order. Please contact support."
                                    );
                                    return;
                                  }

                                  console.log(
                                    "Order saved successfully:",
                                    orderData
                                  );

                                  // Insert order items
                                  if (cart && cart.length > 0) {
                                    const orderItemsPromises = cart.map(
                                      (item) =>
                                        supabase.from("OrderItems").insert({
                                          OrderId: orderNumber,
                                          ProductId: item.ProductId,
                                          ProductName: item.Name,
                                          Quantity: item.quantity,
                                          Price: item.Price,
                                          ItemTotal: parseFloat(
                                            item.Price * item.quantity
                                          ).toFixed(2),
                                          CreatedAt: new Date(),
                                        })
                                    );

                                    const orderItemsResults = await Promise.all(
                                      orderItemsPromises
                                    );
                                    const hasOrderItemsError =
                                      orderItemsResults.some(
                                        (result) => result.error
                                      );

                                    if (hasOrderItemsError) {
                                      console.error(
                                        "Error inserting order items"
                                      );
                                      alert(
                                        "Error saving order items. Please contact support."
                                      );
                                      return;
                                    }
                                  }

                                  // Send email notification after successful database save
                                  emailjs.send(
                                    "service_s481rtv",
                                    "template_771ecr6",
                                    {
                                      to_email: window.globalStore?.state?.Email || "pabloandreychacon@gmail.com",
                                      from_email: customerEmail,
                                      message: `
                                      Order Number: ${orderNumber}\n\n
                                      Customer: ${customerName}\n
                                      Email: ${customerEmail}\n\n
                                      Shipping Method: ${shippingMethod}\n
                                      Shipping Address: ${addressStr}\n\n
                                      Items:\n${itemsList}\n
                                      Subtotal: ${
                                        document.getElementById("subtotal")
                                          .textContent
                                      }\n
                                      Shipping: ${
                                        document.getElementById("shippingCost")
                                          .textContent
                                      }\n
                                      Tax: ${
                                        document.getElementById("tax")
                                          .textContent
                                      }\n
                                      Total: ${
                                        document.getElementById("total")
                                          .textContent
                                      }
                                    `,
                                    }
                                  );

                                  // Show success modal and clear cart only after everything succeeds
                                  document.getElementById(
                                    "orderNumber"
                                  ).textContent = orderNumber;
                                  const modal = new bootstrap.Modal(
                                    document.getElementById("successModal")
                                  );
                                  modal.show();

                                  // Clear cart
                                  localStorage.removeItem("postore_cart");
                                } catch (error) {
                                  console.error(
                                    "Error processing order:",
                                    error
                                  );
                                  alert(
                                    "Error processing order. Please try again or contact support."
                                  );
                                  return;
                                }
                              };

                              document.head.appendChild(script);
                            })
                            .catch(function (error) {
                              console.error("PayPal error:", error);
                              alert(
                                "There was an error processing your payment. Please try again."
                              );
                            });
                        },
                      })
                      .render("#paypal-button-container");
                  }

                  // Initialize PayPal when page loads
                  document.addEventListener("DOMContentLoaded", initPayPal);
                </script>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Success Modal -->
    <div class="modal fade" id="successModal" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-body text-center py-5">
            <i class="bi bi-check-circle-fill text-success display-1 mb-3"></i>
            <h3 class="mb-3">Order Placed Successfully!</h3>
            <p class="text-muted mb-4">
              Thank you for your purchase. You will receive a confirmation email
              shortly.
            </p>
            <div class="mb-4">
              <strong>Order Number: <span id="orderNumber"></span></strong>
            </div>
            <a href="../index.html" class="btn btn-primary"
              >Continue Shopping</a
            >
          </div>
        </div>
      </div>
    </div>

    <script src="../customElements/bottom-scripts.js"></script>
    <custom-bottom></custom-bottom>
    <!-- Checkout JS -->
    <script src="../js/checkout.js"></script>
    
    <script>
      // Update business name when data is ready
      function updateCheckoutBusinessInfo() {
        const businessName = window.globalStore?.state?.BusinessName || "POStore";
        const businessNameElement = document.getElementById("business-name");
        if (businessNameElement) {
          businessNameElement.textContent = businessName;
        }
      }
      
      // Listen for business data loaded event
      window.addEventListener('businessDataLoaded', updateCheckoutBusinessInfo);
      
      // Also check if business data is already loaded
      document.addEventListener('DOMContentLoaded', function() {
        if (window.businessDataReady && window.globalStore?.state) {
          updateCheckoutBusinessInfo();
        }
      });
    </script>
  </body>
</html>
