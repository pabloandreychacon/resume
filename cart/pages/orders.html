<!DOCTYPE html>
<html lang="en">
  <head>
    <script src="../customElements/head-element.js"></script>
    <custom-head
      page-title="Orders - POStore"
      description="View and manage customer orders"
      keywords="orders, customer, management, POStore"
      author="POStore Team"
      favicon-url="../assets/favicon.ico"
      stylesheets="../css/style.css"
      scripts="../js/price-formatter.js"
    ></custom-head>

    <!-- Section Loader JS -->
    <script src="../js/section-loader.js"></script>
    <!-- i18n -->
    <script src="../js/i18n.js"></script>
    <script defer>
      // Load sections when the page is ready
      document.addEventListener("DOMContentLoaded", function () {
        // Load header section
        loadSection("headerSection", "../sections/header.html", "../");
        // Load footer section
        loadSection("footerSection", "../sections/footer.html", "../");
        loadSection(
          "cartComponentsSection",
          "../sections/cart-components.html"
        );
      });
    </script>

    <!-- Global State -->
    <script src="../js/globalState.js"></script>

    <!-- Supabase JS -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="../js/supabase-config.js"></script>
    <script src="../js/business-data.js"></script>
    <script src="../js/store-functions.js"></script>
    <script src="../js/main.js"></script>
    <script src="../js/shared-store.js"></script>
  </head>
  <body>
    <!-- Header Section -->
    <div id="headerSection"></div>

    <!-- Page Header -->
    <section class="bg-primary text-white py-5 mt-5">
      <div class="container">
        <div class="row align-items-center">
          <div class="col-lg-8">
            <h1 class="display-4 fw-bold" data-i18n="customer_orders">Customer Orders</h1>
            <p class="lead" data-i18n="search_view_orders_description">
              Search and view customer orders for your business.
            </p>
          </div>
          <div class="col-lg-4 text-lg-end">
            <nav aria-label="breadcrumb">
              <ol class="breadcrumb justify-content-lg-end mb-0">
                <li class="breadcrumb-item">
                  <a href="../index.html" class="text-white" data-i18n="home">Home</a>
                </li>
                <li
                  class="breadcrumb-item active text-white"
                  aria-current="page"
                >
                  <span data-i18n="orders">Orders</span>
                </li>
              </ol>
            </nav>
          </div>
        </div>
      </div>
    </section>

    <!-- Orders Content -->
    <section class="py-5">
      <div class="container">
        <div class="row justify-content-center">
          <div class="col-lg-10">
            <div class="card shadow-sm">
              <div class="card-header bg-white">
                <h4 class="mb-0">
                  <i class="bi bi-list-check me-2"></i><span data-i18n="search_customer_orders">Search Customer Orders</span>
                </h4>
              </div>
            <div class="card-body">
              <!-- Search Form -->
              <div class="row mb-4">
                <div class="col-md-6">
                  <label for="buyerEmail" class="form-label"
                    ><span data-i18n="customer_email">Customer Email:</span></label
                  >
                  <div class="input-group">
                    <input
                      type="email"
                      class="form-control"
                      id="buyerEmail"
                      placeholder="Enter customer email..."
                      data-i18n-placeholder="enter_customer_email"
                      required
                    />
                    <button
                      class="btn btn-primary"
                      type="button"
                      id="searchOrdersBtn"
                    >
                      <i class="bi bi-search me-2"></i><span data-i18n="search_orders">Search Orders</span>
                    </button>
                  </div>
                  <div id="emailError" class="text-danger mt-2 d-none">
                    <i class="bi bi-exclamation-circle me-1"></i>
                    <span id="emailErrorText"></span>
                  </div>
                </div>
              </div>

              <!-- Loading Indicator -->
              <div id="loadingIndicator" class="text-center py-4 d-none">
                <div class="spinner-border text-primary" role="status">
                  <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2" data-i18n="loading_orders">Loading orders...</p>
              </div>

              <!-- Orders Results -->
              <div id="ordersContainer">
                <div class="text-center text-muted py-5">
                  <i class="bi bi-search display-1"></i>
                  <h5 class="mt-3" data-i18n="enter_email_to_view_orders">
                    Enter a customer email to view their orders
                  </h5>
                </div>
              </div>
              </div>
            </div>
          </div>
        </div>
      </section>

    <!-- Cart Components Section -->
    <div id="cartComponentsSection"></div>

    <!-- Footer Section -->
    <div id="footerSection"></div>

    <script src="../customElements/bottom-scripts.js"></script>
    <custom-bottom></custom-bottom>

    <!-- Performance Optimization -->
    <script src="../js/performance.js"></script>

    <script>
      class OrdersManager {
        constructor() {
          this.orders = [];
          this.init();
        }

        async init() {
          // Wait for business data to be ready
          if (!window.businessDataReady) {
            setTimeout(() => this.init(), 100);
            return;
          }

          this.bindEvents();
        }

        bindEvents() {
          const searchBtn = document.getElementById("searchOrdersBtn");
          const emailInput = document.getElementById("buyerEmail");

          searchBtn.addEventListener("click", () => this.searchOrders());

          emailInput.addEventListener("keypress", (e) => {
            if (e.key === "Enter") {
              this.searchOrders();
            }
          });
          
          emailInput.addEventListener("input", () => {
            this.hideEmailError();
          });
        }

        async searchOrders() {
          const buyerEmail = document.getElementById("buyerEmail").value.trim();
          
          // Hide previous errors
          this.hideEmailError();

          if (!buyerEmail) {
            this.showEmailError(window.i18n?.t("please_enter_customer_email") || "Please enter a customer email");
            return;
          }

          const businessEmail = window.globalStore?.state?.Email;
          if (!businessEmail) {
            this.showEmailError(window.i18n?.t("business_email_not_available") || "Business email not available");
            return;
          }

          this.showLoading(true);

          try {
            const { data, error } = await supabase
              .from("Orders")
              .select("*")
              .eq("BuyerEmail", buyerEmail)
              .eq("BusinessEmail", businessEmail)
              .order("CreatedAt", { ascending: false });

            if (error) {
              console.error("Error fetching orders:", error);
              this.showError(window.i18n?.t("error_loading_orders") || "Error loading orders. Please try again.");
              return;
            }

            this.orders = data || [];
            this.renderOrders();
          } catch (error) {
            console.error("Error:", error);
            this.showError(window.i18n?.t("error_loading_orders") || "Error loading orders. Please try again.");
          } finally {
            this.showLoading(false);
          }
        }

        showLoading(show) {
          const loading = document.getElementById("loadingIndicator");
          if (show) {
            loading.classList.remove("d-none");
          } else {
            loading.classList.add("d-none");
          }
        }

        showEmailError(message) {
          const errorElement = document.getElementById("emailError");
          const errorText = document.getElementById("emailErrorText");
          const emailInput = document.getElementById("buyerEmail");
          
          errorText.textContent = message;
          errorElement.classList.remove("d-none");
          emailInput.classList.add("is-invalid");
          emailInput.focus();
        }
        
        hideEmailError() {
          const errorElement = document.getElementById("emailError");
          const emailInput = document.getElementById("buyerEmail");
          
          errorElement.classList.add("d-none");
          emailInput.classList.remove("is-invalid");
        }

        showError(message) {
          const container = document.getElementById("ordersContainer");
          container.innerHTML = `
            <div class="text-center text-danger py-5">
              <i class="bi bi-exclamation-triangle display-1"></i>
              <h5 class="mt-3">${message}</h5>
            </div>
          `;
        }

        renderOrders() {
          const container = document.getElementById("ordersContainer");

          if (this.orders.length === 0) {
            container.innerHTML = `
              <div class="text-center text-muted py-5">
                <i class="bi bi-inbox display-1"></i>
                <h5 class="mt-3">${window.i18n?.t("no_orders_found") || "No orders found"}</h5>
                <p>${window.i18n?.t("customer_no_orders_yet") || "This customer has no orders yet."}</p>
              </div>
            `;
            return;
          }

          const ordersHtml = this.orders
            .map((order) => this.createOrderCard(order))
            .join("");
          container.innerHTML = `
            <div class="mb-3">
              <h6 class="text-muted">${window.i18n?.t("found_orders_count") || "Found"} ${this.orders.length} ${window.i18n?.t("order_s") || "order(s)"}</h6>
            </div>
            ${ordersHtml}
          `;
        }

        createOrderCard(order) {
          const statusClass = this.getStatusClass(order.StatusId);
          const statusText = this.getStatusText(order.StatusId);
          const createdDate = new Date(order.CreatedAt).toLocaleDateString();
          const updatedDate = new Date(order.UpdatedAt).toLocaleDateString();

          return `
            <div class="card mb-3">
              <div class="card-header d-flex justify-content-between align-items-center">
                <div>
                  <h6 class="mb-0">Order #${order.Id}</h6>
                  <small class="text-muted">Created: ${createdDate}</small>
                </div>
                <span class="badge ${statusClass}">${statusText}</span>
              </div>
              <div class="card-body">
                <div class="row">
                  <div class="col-md-6">
                    <p><strong>${window.i18n?.t("total_amount") || "Total Amount"}:</strong> ${StoreFunctions.formatPrice(order.TotalAmount)} </p>
                    <p><strong>${window.i18n?.t("payment_order_id") || "Payment Order ID"}:</strong> ${
                      order.PaymentOrderId || "N/A"
                    }</p>
                    <p><strong>${window.i18n?.t("shipping_method") || "Shipping Method"}:</strong> ${
                      order.ShippingMethod
                    }</p>
                    ${
                      order.TrackingNumber
                        ? `<p><strong>${window.i18n?.t("tracking") || "Tracking"}:</strong> ${order.TrackingNumber}</p>`
                        : ""
                    }
                  </div>
                  <div class="col-md-6">
                    <p><strong>${window.i18n?.t("customer") || "Customer"}:</strong> ${order.BuyerEmail}</p>
                    <p><strong>${window.i18n?.t("updated") || "Updated"}:</strong> ${updatedDate}</p>
                    ${
                      order.EstimatedDeliveryDate
                        ? `<p><strong>${window.i18n?.t("est_delivery") || "Est. Delivery"}:</strong> ${new Date(
                            order.EstimatedDeliveryDate
                          ).toLocaleDateString()}</p>`
                        : ""
                    }
                  </div>
                </div>
                
                <div class="mt-3">
                  <button class="btn btn-sm btn-outline-primary" onclick="ordersManager.viewOrderItems('${order.PaymentOrderId}', ${order.Id})">
                    <i class="bi bi-list-ul me-1"></i>${window.i18n?.t("view_order_items") || "View Order Items"}
                  </button>
                </div>
                
                <div id="orderItems-${order.Id}" class="mt-3 d-none">
                  <!-- Order items will be loaded here -->
                </div>
                
                ${
                  order.ShippingAddress
                    ? `
                  <div class="mt-3">
                    <h6>${window.i18n?.t("shipping_address") || "Shipping Address"}:</h6>
                    <p class="mb-1">${order.ShippingAddress.replace(
                      /\n/g,
                      "<br>"
                    )}</p>
                  </div>
                `
                    : ""
                }
                
                ${
                  order.Notes
                    ? `
                  <div class="mt-3">
                    <h6>${window.i18n?.t("notes") || "Notes"}:</h6>
                    <p class="mb-0">${order.Notes}</p>
                  </div>
                `
                    : ""
                }
              </div>
            </div>
          `;
        }

        getStatusClass(status) {
          switch (status) {
            case 1:
            case 2:
            case 3:
              return "bg-success";
            case 0:
              return "bg-warning text-dark";
            case 4:
              return "bg-danger";
            default:
              return "bg-secondary";
          }
        }

        getStatusText(status) {
          switch (status) {
            case 0:
              return window.i18n?.t("status_pending") || "Pending";
            case 1:
              return window.i18n?.t("status_paid") || "Paid";
            case 2:
              return window.i18n?.t("status_shipped") || "Shipped";
            case 3:
              return window.i18n?.t("status_delivered") || "Delivered";
            case 4:
              return window.i18n?.t("status_canceled") || "Canceled";
            default:
              return window.i18n?.t("status_unknown") || "Unknown";
          }
        }
        async viewOrderItems(paymentOrderId, orderId) {
          const container = document.getElementById(`orderItems-${orderId}`);
          const button = event.target.closest('button');
          
          if (!container.classList.contains('d-none')) {
            // Hide if already visible
            container.classList.add('d-none');
            button.innerHTML = `<i class="bi bi-list-ul me-1"></i>${window.i18n?.t("view_order_items") || "View Order Items"}`;
            return;
          }
          
          // Show loading
          container.innerHTML = `<div class="text-center py-2"><div class="spinner-border spinner-border-sm" role="status"></div> ${window.i18n?.t("loading_items") || "Loading items..."}</div>`;
          container.classList.remove('d-none');
          button.innerHTML = `<i class="bi bi-eye-slash me-1"></i>${window.i18n?.t("hide_order_items") || "Hide Order Items"}`;
          
          try {
            const { data, error } = await supabase
              .from('OrderItems')
              .select('*')
              .eq('OrderId', paymentOrderId)
              .order('CreatedAt', { ascending: true });
              
            if (error) {
              console.error('Error fetching order items:', error);
              container.innerHTML = `<div class="alert alert-danger">${window.i18n?.t("error_loading_order_items") || "Error loading order items"}</div>`;
              return;
            }
            
            this.renderOrderItems(container, data || []);
            
          } catch (error) {
            console.error('Error:', error);
            container.innerHTML = `<div class="alert alert-danger">${window.i18n?.t("error_loading_order_items") || "Error loading order items"}</div>`;
          }
        }
        
        renderOrderItems(container, items) {
          if (items.length === 0) {
            container.innerHTML = `<div class="alert alert-info">${window.i18n?.t("no_items_found_for_order") || "No items found for this order"}</div>`;
            return;
          }
          
          const itemsHtml = items.map(item => `
            <div class="border rounded p-2 mb-2 bg-light">
              <div class="row align-items-center">
                <div class="col-md-6">
                  <strong>${item.ProductName}</strong>
                  <br><small class="text-muted">${window.i18n?.t("product_id") || "Product ID"}: ${item.ProductId}</small>
                </div>
                <div class="col-md-2 text-center">
                  <span class="badge bg-secondary">${window.i18n?.t("qty") || "Qty"}: ${item.Quantity}</span>
                </div>
                <div class="col-md-2 text-center">
                  ${StoreFunctions.formatPrice(parseFloat(item.Price))}
                </div>
                <div class="col-md-2 text-end">
                  <strong>${StoreFunctions.formatPrice(parseFloat(item.ItemTotal))}</strong>
                </div>
              </div>
            </div>
          `).join('');
          
          const totalAmount = items.reduce((sum, item) => sum + parseFloat(item.ItemTotal), 0);
          
          container.innerHTML = `
            <div class="border rounded p-3 bg-white">
              <h6 class="mb-3">${window.i18n?.t("order_items") || "Order Items"} (${items.length})</h6>
              ${itemsHtml}
              <hr>
              <div class="text-end">
                <strong>${window.i18n?.t("items_total") || "Items Total"}: ${StoreFunctions.formatPrice(totalAmount)}</strong>
              </div>
            </div>
          `;
        }
      }

      // Initialize when DOM is ready
      let ordersManager;
      document.addEventListener("DOMContentLoaded", () => {
        ordersManager = new OrdersManager();
        
        // Wait for sections to load
        document.addEventListener("sectionLoaded", function (e) {
          if (e.detail.id === "headerSection") {
            // Add active class to the Orders nav link
            document.querySelectorAll(".nav-link").forEach((link) => {
              if (link.getAttribute("href").includes("orders")) {
                link.classList.add("active");
              }
            });
          }
        });
      });
    </script>
  </body>
</html>
